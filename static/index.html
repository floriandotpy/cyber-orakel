<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Orakel</title>
    <link rel="stylesheet" href="static/style.css">
    <link rel="stylesheet" href="static/loading.css">
</head>
<body>
    <div class="logo">
        <img src="static/logo.png" alt="Cyber Orakel Logo">
    </div>
    <div class="container">
        <div id="step-1">
            <h1 class="question">
                Was ist dein Cyber-Sternzeichen?
            </h1>
            <div id="step-1-content" class="grid">
                <!-- Buttons will be dynamically added here -->
            </div>
        </div>
        <div id="loading" class="hidden">
            <h1 class="question">
                Das Orakel cybert, bitte warten
            </h1>
            <div class="loading-animation">
                CYBER IN PROGRESS...
            </div>
        </div>
        <div id="result" class="hidden">
            <h1 class="question">
                Die Sterne sagen:
            </h1>
            <p id="fortune-result" class="fortune-result">
                <!-- Fortune will be dynamically added here-->
            </p>
            <div class="text-center">
                <button id="restart" class="button margin-top-small">Neu starten</button>
            </div>
        </div>
    </div>
    <script>
        const serverUrl = 'http://localhost:8000';

        async function fetchZodiacs() {
            const response = await fetch(`${serverUrl}/zodiacs`);
            const zodiacs = await response.json();
            return zodiacs;
        }

        function renderButtons(zodiacs) {
            const container = document.getElementById('step-1');
            const content = document.getElementById('step-1-content');
            content.innerHTML = ''; // Clear any existing buttons

            zodiacs.forEach(zodiac => {
                const button = document.createElement('button');
                button.className = 'button';
                button.innerText = zodiac.display_name;
                button.addEventListener('click', async function() {
                    const sentiment = 'random';

                    document.getElementById('step-1').classList.add('hidden');
                    document.getElementById('loading').classList.remove('hidden');

                    const response = await fetch(`${serverUrl}/fortune?zodiac=${zodiac.key}&sentiment=${sentiment}`);
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fortuneText = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        fortuneText += decoder.decode(value, { stream: true });
                        document.getElementById('fortune-result').innerText = fortuneText;
                    }

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('result').classList.remove('hidden');
                });
                content.appendChild(button);
            });
        }

        document.getElementById('restart').addEventListener('click', function() {
            document.getElementById('result').classList.add('hidden');
            document.getElementById('step-1').classList.remove('hidden');
        });

        // Fetch zodiacs and render buttons on page load
        fetchZodiacs().then(renderButtons);
    </script>
</body>
</html>